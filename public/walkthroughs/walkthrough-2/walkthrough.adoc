// Attributes
:integreatly: Integreatly
:messaging-service: Red Hat AMQ Online
:messaging-service-version: 7.2
:integration-service: Fuse
:integration-service-version: 7.1
:che-service: Che
:launcher-service: Launcher
:api-mgmt-service: 3Scale
:AMQ-ProductLongName: Red Hat AMQ
:AMQ-BrokerVersion: 7.2
:Fuse-prodnamefull: Red Hat Fuse
:Fuse-version: 7.1
:3Scale-ProductName: Red Hat 3scale
:3Scale-ProductVersion: 2.3
:EnMasse-master-ProductLongName: EnMasse
:walkthrough: Integrating API-driven applications

= Integrating API-driven applications

:context: integrating-api-driven-applications

Integrate an API that provides flight information, ensuring that the API is protected and rate limited.

APIs are the ideal channel for organizations who want to reach audiences whenever, wherever, and however they choose.
This enables innovation, mobile and partner development.
However, it also exposes the hosting infrastructure and organization.
It is possible to protect and limit access to an API using {api-mgmt-service} as part of your integration.

This walkthrough describes how to create such an integration, using OpenShift, {launcher-service}, {che-service} and {api-mgmt-service}.

++++
<img src="/images/wt2.png" class="img-responsive" alt="integration">
++++

[type=walkthroughResource]
=== Red Hat OpenShift
* link:{openshift-host}/console[Open Console]
* link:https://help.openshift.com/[Openshift Online Help Center]
* link:https://blog.openshift.com/[Openshift Blog]

[type=walkthroughResource]
=== Launcher
* link:{launcher-url}[Open Console]
* link:https://developers.redhat.com/products/openshiftio/overview/[Launcher Overview]
* link:https://launcher.fabric8.io/docs/[Launcher Documentation]

[type=walkthroughResource]
=== Eclipse Che
* link:{che-url}[Open Console]
* link:https://developers.redhat.com/products/che/overview/[Eclipse Che Overview]
* link:https://www.eclipse.org/che/docs/index.html[Eclipse Che Documentation]

[type=walkthroughResource]
=== 3Scale
* link:{api-management-url}[Open Console]
* link:https://developers.redhat.com/products/3scale/overview/[3Scale Overview]
* link:https://www.3scale.net[3Scale Website]

:sectnums:

[time=5]
== Deploying the Fuse Aggregation App

The Fuse Aggregation App provides information about flights, you deploy it using Launcher.

[id='deploying-fuse-aggregation-app_{context}']
[.integr8ly-docs-header]
=== Deploying the Fuse Aggregation App


// TODO placeholders for product names
// TODO append /launch/wizard/<project-name> to launcher url
// TODO flights endpoint url
. Log in to the link:{launcher-url}/launch/wizard/{walkthrough-namespace}[{launcher-service}, window="_blank"] wizard.

. Select the option to *Code Locally, Build and Deploy* in the *Select Target Environment* step.

. Select the *Authorize* button to allow Launcher create resources in the OpenShift cluster. This triggers an OAuth flow, and eventually redirects back to the {launcher-service} wizard.

. Select the blue down-arrow icon to continue the wizard.

. Select the *Aggregation* mission and *Fuse* runtime in the *Select Mission & Runtime* step

. Select the blue down-arrow icon to continue the wizard.

. Authorize your Github Account
.. Select the *Log In & Authorize Account* button in the *Authorize Git Provider* step.
.. This opens a Github OAuth page.
.. Select the *Authorize <organisation/user>* button at the bottom.
.. You will be redirected back to the {launcher-service} wizard.

. Select all blue down-arrow icons to continue the wizard, accepting the git repository name.

. Select the *Set Up Application* button to create a Git repository and provision the mission resources to OpenShift. A build for the *Fuse Aggregation App* is triggered and deployed.


[type=verification]
. Make sure following pods are running in the link:{openshift-host}/console/project/{walkthrough-namespace}[OpenShift Project, window="_blank"]:
+
* fuse-flights-aggregator
+
* arrivals
+
* departures
// TODO: flights api links to /camel/flights
. Navigate to the link:https://{fuse-aggregator-url}/camel/flights[Flights Endpoint, window="_blank"] and check that the response includes details about 8 flights.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

:sectnums!:

// Task resources go here

:sectnums:

[time=10]
== Modifying the Fuse Aggregation App

Modify the Fuse Aggregation App to aggregate flights data from the Arrivals & Deparatures servers

[id='modifying-fuse-aggregation-app_{context}']
[.integr8ly-docs-header]
=== Modifying the Fuse Aggregation App


// TODO placeholders for product names
// TODO project name
. Log in to the link:{che-url}[Che, window="_blank"] Dashboard

. The *New Workspace* page is displayed. Create a new Workspace:
.. Use the *Java* stack.
.. Select the *Add or Import Project* button.
.. Select the *Github* tab.
.. Select the *Connect your Github Account* button.
.. Select the checkbox beside the git repository named *{walkthrough-namespace}*. You may need to filter by account if you are a member of any Organizations.
.. Select the *Add* button to add the repository to the workspace.
.. Select the *Create* button at the bottom.
.. Select *Open in IDE*.
+
. Open the file at *src/main/java/com/redhat/fuse/boosters/rest/http/CamelRouter.java*.
+
// TODO: explain what the app is doing and why we're modifying it
+
. Comment out the routing code that talks to local java services.
.. Navigate to the section of the file with a comment of `// COMMENT OUT THIS`.
.. Comment out the line of code below this using double slashes *//*.
+
. Uncomment the routing code that talks to remote services.
.. Navigate to the section of the file with a comment of `// UNCOMMENT THIS`.
.. Uncomment the line of code below this by removing the double slashes.
+
. Before the changes can be commited and pushed to the repository, you must specify a name and email to associate with commits:
.. Select the *Profile* menu, then *Preferences*.
.. Choose the *Commiter* option under the *Git* heading.
.. Set a *Name* and *Email*.
.. Select *Save* then *Close*.

. Commit and push the changes back to the repository:
.. Select the *Git* menu, then *Commit*.
.. Ensure the *CamelRouter.java* file is checked.
.. Enter a commit message of *Switch to remote services* in the input area.
.. Check the box for *Push commited changes to* and ensure the branch is set to *master*.
.. Select the *Commit* button.
.. A green notification *Pushed to Origin* is displayed.
.. A new build will be triggered in OpenShift and rollout the new changes to the *Fuse Aggregation App*.

[type=verification]
// TODO: flights api links to /camel/flights
After waiting for the build and depoyment to complete, check that link:https://{fuse-aggregator-url}/camel/flights[Flights Endpoint, window="_blank"] responds with more than 8 flights.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

:sectnums!:

// Task resources go here

:sectnums:


[time=15]
== Managing the Fuse Aggregation App endpoint

=== API Management Login

// TODO service & url placeholders
. Open the link:{api-management-url}[{3Scale-ProductName} Login screen, window="_blank"].

. Select the *Red Hat Single Sign On* option. This triggers an OAuth Flow and redirects you back to the {3Scale-ProductName} Dashboard.

. Dismiss the *How does 3Scale work?* option which is displayed the first time you log in to {3Scale-ProductName}. The main Dashboard is displayed.

[type=verification]
Make sure you can see the {3Scale-ProductName} Dashboard and can navigate the main menu.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

=== Adding the Fuse Aggregation App Endpoint to {3Scale-ProductName}

. Select the *API* menu item from the top of the screen.

. Select *Create Service* from the top right of the *API* screen.
+
// TODO: dynamic fuse aggregation app name based on user id/email. "Only ASCII letters, numbers, dashes and underscores are allowed" for System name. e.g. fuse-aggregation-app-test01-example-com
. Enter the following as the *Name* and *System name*:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----

. Leave the *Description* field empty.

. Leave the *Gateway* option as APIcast.

. Leave the *Authentication* option as *API Key (user_key)*.

. Select *Create Service* at the bottom of the screen.

. After the service is created, expand the new *{fuse-aggregator-app-name}* API Service and select the *Configure APIcast* button.
// The 'fuse-aggregation-app-url' should be the url of the Fuse Aggregation App e.g. https://fuse-flights-aggregator-ak49.cluster-lfa3xlh.opentry.me/
. In the *Private Base URL* field, enter:
+
[subs="attributes+"]
----
https://{fuse-aggregator-url}
----
// The '{fuse-aggregation-app-apicast-route-url}' shoudl be the apicast-staging route url for this specific user. It can be looked up or deterministicly set.
. In the *Staging Public Base URL*, enter:
+
[subs="attributes+"]
----
https://wt2-{user-sanitized-username}-3scale.{openshift-app-host}
----
+
Note that this route should point to the shared staging APIcast in the *3scale* project in OpenShift.  Your administrator should have created this route for you. If it does not exist, contact your administrator to create the route.

. Select *Update & test in Staging Environment*

[type=verification]
Check that the API service is available.
You might encounter a *403: Authentication failed* message. You can ignore this message, the issue is resolved in a later step.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

=== Setting Fuse Aggregation App Endpoint Limits

. Create a new *Application Plan*:
.. Select *Application Plans* from the left menu.
.. Select *Create Application Plan*.
.. Enter the following for *Name* and *System name*:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----
.. Select *Create Application Plan*.
.. Select the *Publish* button to publish the Plan.

. Select the *{fuse-aggregator-app-name}* plan to return to the edit screen.

. Set a limit of 5 calls per hour:
.. On the *Metrics, Methods, Limits & Pricing Rules* section, select the *Limits (0)* button.
.. Select the *New usage limit* button.
.. Set the *Period* to *hour*.
.. Set the *Max. value* to *5*.
.. Select *Create usage limit*.

. Create a new *Application* for the *Developer* Group, assigned to the Plan:
.. Select the *Developers* menu at the top.
.. Select the *Developer* Account to open the *Account Summary* page.
.. Select the *(num) Application* item from the breadcrumb to view Applications.
.. Select the *Create Application* button in the top right.
.. Select the *{fuse-aggregator-app-name}* Plan in the *Application plan* dropdown.
.. Enter the following for *Name* and *Description*:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----
.. Select *Create Application*.

. Set a custom *User Key* for the application:
.. On the *{fuse-aggregator-app-name}* application screen, scroll to the *API Credentials* section.
.. Select *Set Custom Key*.
.. In the *Custom User Key* field, enter:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----
.. Select *Set Custom Key*.

[type=verification]
****
. Select the *APIs* menu item at the top.

. Expand the *{fuse-aggregator-app-name}* service.

. Select the *Configure APIcast* button.

. Select the *Update & test in Staging Environment* button at the bottom again.

. Check that a success message is displayed, and a green line along the left side of the page.
****

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

[id='fuse-aggregation-app-endpoint-activedocs_{context}']
[.integr8ly-docs-header]
=== Create a new ActiveDocs Service

. Select the *APIs* menu item at the top to return to the *APIs* Overview page.

. Select the *ActiveDocs* tab.

. Select *Create a new spec*.

. Enter the following for *Name* and *System name*:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----

. Enter the below content for the *API JSON Spec*.
+
[subs="attributes"]
----
{
  "swagger" : "2.0",
  "info" : {
    "version" : "1.0",
    "title" : "Airport Flights REST API"
  },
  "host" : "wt2-{user-sanitized-username}-3scale.{openshift-app-host}",
  "basePath" : "/camel/",
  "tags" : [ {
    "name" : "flights",
    "description" : "List all flights (arrivals & departures)"
  } ],
  "schemes" : [ "https" ],
  "paths" : {
    "/flights" : {
      "get" : {
        "tags" : [ "flights" ],
        "operationId" : "flights-api",
        "parameters" : [ {
          "name" : "user_key",
          "in" : "query",
          "description" : "User Key, if calling the API in front of 3Scale.",
          "required" : false,
          "type" : "string",
          "x-data-threescale-name": "user_keys"
        } ],
        "responses" : {
          "200" : {
            "description" : "Output type",
            "schema" : {
              "type" : "string",
              "format" : "com.redhat.fuse.boosters.rest.http.FlightsList"
            }
          }
        }
      }
    }
  },
  "definitions" : {
    "Flight" : {
      "type" : "object",
      "properties" : {
        "code" : {
          "type" : "string"
        },
        "time" : {
          "type" : "integer",
          "format" : "int64"
        },
        "flightType" : {
          "type" : "string"
        }
      }
    }
  }
}
----
// TODO: spec from fuse aggregation app, with 2 modifications:
//     - 'host' field set to the fuse-aggregation-app-apicast-route-url attribute
//     - add a field to the 'user_key' parameter, 'x-data-threescale-name' with value of 'user_keys' (needed for autofill later)
//
// The swagger spec comes from the /camel/api-doc endpoint in the fuse-aggregation app. e.g.
+
////
{
  "swagger" : "2.0",
  "info" : {
    "version" : "1.0",
    "title" : "Airport Flights REST API"
  },
  "host" : "wt2-f2-3scale-apicast-staging-3scale-3scale.cluster-lfa3xlh.opentry.me",
  "basePath" : "/camel/",
  "tags" : [ {
    "name" : "flights",
    "description" : "List all flights (arrivals & departures)"
  } ],
  "schemes" : [ "https" ],
  "paths" : {
    "/flights" : {
      "get" : {
        "tags" : [ "flights" ],
        "operationId" : "flights-api",
        "parameters" : [ {
          "name" : "user_key",
          "in" : "query",
          "description" : "User Key, if calling the API in front of 3Scale.",
          "required" : false,
          "type" : "string",
          "x-data-threescale-name": "user_keys"
        } ],
        "responses" : {
          "200" : {
            "description" : "Output type",
            "schema" : {
              "type" : "string",
              "format" : "com.redhat.fuse.boosters.rest.http.FlightsList"
            }
          }
        }
      }
    }
  },
  "definitions" : {
    "Flight" : {
      "type" : "object",
      "properties" : {
        "code" : {
          "type" : "string"
        },
        "time" : {
          "type" : "integer",
          "format" : "int64"
        },
        "flightType" : {
          "type" : "string"
        }
      }
    }
  }
}
////
+
. Select the *Create Service* button.

ifdef::location[]

.To verify this procedure:
// tag::verification[]
The *Airport Flights REST API* ActiveDoc is created and has a *List all flights* API endpoint.
// end::verification[]

.If your verification fails:
// tag::verificationNo[]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
// end::verificationNo[]
endif::location[]

[type=verification]
The *Airport Flights REST API* ActiveDoc is created and has a *List all flights* API endpoint.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

:sectnums!:

// Task resources go here

:sectnums:

[time=30]
== Calling Fuse Aggregation App endpoint

=== Checking the API Service is protected

. From the *ActiveDocs* page for the *{fuse-aggregator-app-name}* Application, expand the *GET /flights* endpoint.
. Leave the *user_key* field empty.
. Select the *Try it out!* button.

[type=verification]
****
Check that {3Scale-ProductName} is rejecting the request, as there is no `user_key` specified.

* The *Response Body* is `no content`

* The *Response Code* is 0
****

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

=== Validating access to the API Service

. In the *user_key* field, enter:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----
. Select the *Try it out!* button.

[type=verification]
****
Check that:

* the *Response Code* is 200

* the *Response Body* shows a *JSON Array* of flights
****

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

=== Verifying access to the API Service is limited

. In the *user_key* field, enter:
+
[subs="attributes+"]
----
{fuse-aggregator-app-name}
----
. Click the *Try it out!* button repeatedly until the *Response Code* is *0*, this
should require less than 5 clicks (the hourly limit set earlier).
. Select the *Applications* tab from the top menu.
. Select the *{fuse-aggregator-app-name}* application from the *Applications* list.
. Scroll down to the *Current Utilization* section.

[type=verification]
****
Check that the following is displayed:

. *Hits %* in the *Current Utilization* section is `100%`.
****

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.

=== Monitoring the API Service

. Select the *Analytics* tab from the top menu.
. Select *{fuse-aggregator-app-name}* from the *Monitoring* section.

[type=verification]
Check that analytics show the service requests.

[type=verificationFail]
Verify that you followed each step in the procedure above.  If you are still having issues, contact your administrator.
